# CI pipeline using Nix for reproducible builds
# Provides consistent development environments across systems

name: CI
env:
  JDK_JAVA_OPTIONS: -XX:+PrintCommandLineFlags
'on':
  workflow_dispatch: {}
  release:
    types:
    - published
  push: {}
  pull_request:
    branches-ignore:
    - gh-pages
concurrency:
  group: ${{ github.workflow }}-${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) && github.run_id || github.ref }}
  cancel-in-progress: true
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - name: Git Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: '0'
    - name: Install Nix
      uses: cachix/install-nix-action@v26
      with:
        nix_path: nixpkgs=channel:nixos-24.05
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - name: Setup Cachix
      uses: cachix/cachix-action@v14
      continue-on-error: true
      with:
        name: zionomicon
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Cache SBT and Coursier
      uses: actions/cache@v4
      with:
        path: |
          ~/.sbt
          ~/.cache/coursier
          ~/.ivy2/cache
        key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/build.properties') }}
        restore-keys: |
          ${{ runner.os }}-sbt-
    - name: Check all code compiles
      run: nix develop .#ci -c sbt +Test/compile
    - name: Check artifacts build process
      run: nix develop .#ci -c sbt +publishLocal
  lint:
    name: Lint
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
    - name: Git Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: '0'
    - name: Install Nix
      uses: cachix/install-nix-action@v26
      with:
        nix_path: nixpkgs=channel:nixos-24.05
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - name: Setup Cachix
      uses: cachix/cachix-action@v14
      continue-on-error: true
      with:
        name: zionomicon
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Cache SBT and Coursier
      uses: actions/cache@v4
      with:
        path: |
          ~/.sbt
          ~/.cache/coursier
          ~/.ivy2/cache
        key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/build.properties') }}
        restore-keys: |
          ${{ runner.os }}-sbt-
    - name: Lint
      run: nix develop .#ci -c sbt lint
  test:
    name: Test
    runs-on: ubuntu-latest
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        java:
        - '11'
        - '17'
        - '21'
    steps:
    - name: Git Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: '0'
    - name: Install Nix
      uses: cachix/install-nix-action@v26
      with:
        nix_path: nixpkgs=channel:nixos-24.05
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - name: Setup Cachix
      uses: cachix/cachix-action@v14
      continue-on-error: true
      with:
        name: zionomicon
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Cache SBT and Coursier
      uses: actions/cache@v4
      with:
        path: |
          ~/.sbt
          ~/.cache/coursier
          ~/.ivy2/cache
        key: ${{ runner.os }}-sbt-java${{ matrix.java }}-${{ hashFiles('**/build.sbt', '**/build.properties') }}
        restore-keys: |
          ${{ runner.os }}-sbt-java${{ matrix.java }}-
          ${{ runner.os }}-sbt-
    - name: Setup Test Environment with Java ${{ matrix.java }}
      run: |
        cat > flake-test.nix << 'EOF'
        {
          description = "Test environment with Java ${{ matrix.java }}";
          inputs = {
            nixpkgs.url = "github:NixOS/nixpkgs/nixos-24.05";
          };
          outputs = { self, nixpkgs }: 
            let pkgs = nixpkgs.legacyPackages.x86_64-linux;
            in {
              devShells.x86_64-linux.default = pkgs.mkShell {
                buildInputs = [ 
                  pkgs.jdk${{ matrix.java }}_headless 
                  pkgs.sbt 
                  pkgs.libuv 
                  pkgs.coursier 
                ];
                JAVA_HOME = "${pkgs.jdk${{ matrix.java }}_headless}";
                SBT_OPTS = "-Xmx2G -XX:+UseG1GC";
              };
            };
        }
        EOF
    - name: Test
      run: nix develop ./flake-test.nix -c sbt +test
  ci:
    name: ci
    runs-on: ubuntu-latest
    continue-on-error: false
    needs:
    - lint
    - test
    - build
    steps:
    - name: Report Successful CI
      run: echo "ci passed"
